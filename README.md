# **PR Reviewer Assignment Service**

Сервис для автоматического назначения ревьюверов на Pull Request’ы (PR), управления командами и активностью пользователей.
Разработан как решение для тестового задания «Backend стажер, осенняя волна 2025».

---

# 📘 **Описание задачи**

Сервис предоставляет HTTP API для:

* управления пользователями и командами,
* создания PR,
* автоматического назначения ревьюверов,
* переназначения ревьюверов,
* завершения PR (merge).

Основные правила назначения ревьюверов:

1. При создании PR автоматически выбираются **до двух активных** ревьюверов из **команды автора**, исключая самого автора.
2. При переназначении ревьювер меняется на случайного **активного участника команды заменяемого**.
3. После `MERGED` список ревьюверов **изменять нельзя**.
4. Если активных участников недостаточно — назначается доступное количество (0 или 1).

---

# 📂 **Структура проекта**

```text
.
├── cmd/
│   └── main.go              # Точка входа: инициализация сервиса и запуск HTTP-сервера
│
├── docker-compose.yaml      # Полное окружение: сервис + PostgreSQL
├── Dockerfile               # Сборка приложения
│
├── docs/
│   ├── openapi.yaml         # OpenAPI-спецификация API
│   └── codegen.yaml         # Настройки для oapi-codegen (использовалось для генерации DTO)
│
├── internal/                # Основная бизнес-логика приложения
│   ├── config/              # Загрузка конфигурации
│   │   └── config.go
│   │
│   ├── dto/                 # DTO — структуры запросов и ответов API
│   │   ├── error_response.go
│   │   ├── user.go
│   │   ├── team.go
│   │   ├── team_member.go
│   │   ├── pull_request.go
│   │   └── pull_request_short.go
│   │
│   ├── handlers/            # HTTP-ручки (контроллеры)
│   │   ├── user.go
│   │   ├── team.go
│   │   ├── pull_request.go
│   │   └── response.go
│   │
│   ├── mapper/              # Преобразование DTO ⇄ Models
│   │   ├── dto_from_models.go
│   │   └── models_from_dto.go
│   │
│   ├── models/              # Бизнес-сущности
│   │   ├── user.go
│   │   ├── team.go
│   │   ├── team_member.go
│   │   ├── pull_request.go
│   │   └── pull_request_short.go
│   │
│   ├── repository/          # Доступ к данным
│   │   ├── postgres/        # SQL-репозитории
│   │   │   ├── user/
│   │   │   ├── team/
│   │   │   └── pull_request/
│   │   ├── user.go          # Интерфейсы
│   │   ├── team.go
│   │   └── pull_request.go
│   │
│   ├── server/              # HTTP-сервер + маршрутизация
│   │   ├── router.go
│   │   └── server.go
│   │
│   └── service/             # Бизнес-логика (координация работы между слоями)
│       ├── user.go
│       ├── team.go
│       └── pull_request.go
│
├── migrations/              # SQL-миграции (исполняются при docker-compose up)
│   └── 20251118100813_init_schema.sql
│
├── pkg/                     # Переиспользуемые утилиты
│   ├── logger/              # Обёртка над zap
│   ├── postgres/            # Построение подключения + хелперы
│   └── errors/              # Типизированные ошибки
│
├── scripts/
│   └── wait_for_postgres.sh # Скрипт ожидания запуска Postgres
│
├── tools/
│   └── goose/               # Docker-обёртка для миграций
│
├── Makefile                 # Команды сборки/запуска
├── LICENSE
└── README.md
```

---

# ⚙️ **Требования**

* Go 1.21+
* PostgreSQL
* Docker & Docker Compose

---

# ▶️ **Запуск**

### 1. Клонировать проект

```bash
git clone <your-repo-url>
cd <project>
```

### 2. Запустить сервис

```bash
make up
```

Сервис будет доступен на:
 **[http://localhost:8080](http://localhost:8080)**

### 3. Логи

```bash
make logs
```

### 4. Сборка контейнера

```bash
make build
```

### 5. Остановить окружение

```bash
make down
```

---

#  **Команды Makefile**

| Команда        | Описание                                           |
| -------------- | -------------------------------------------------- |
| `make up`      | Запустить сервис + БД                              |
| `make logs`    | Смотреть логи                                      |
| `make build`   | Пересобрать docker-образы                          |
| `make down`    | Остановить и удалить контейнеры                    |
| `make clean`   | Полная очистка окружения                           |
| `make test`    | Запуск тестов                                      |
| `make codegen` | Генерация DTO (не используется в финальной сборке) |

---

#  **Архитектура**

Сервис построен по классической многослойной структуре:

```
Handlers → Service → Repository → PostgreSQL
```

* **Handlers** — принимают HTTP запросы.
* **Service layer** — бизнес-логика (назначения ревьюверов, правила PR, проверки).
* **Repository** — работа с БД.
* **PostgreSQL** — хранилище данных.

---

# ❗ **Допущения и решения спорных моментов**

### 1. Генерация моделей через oapi-codegen

Была использована только для черновой генерации типов,
но **в продакшене используется вручную написанная модель**, поэтому директория `dto/gen/` удалена.

### 2. Миграции выполняются автоматически

При `docker-compose up` Postgres поднимается → goose миграции применяются автоматически.

### 3. Merge — идемпотентный

Повторный вызов не изменяет данные и возвращает текущее состояние PR.

---

#  **Лицензия**

MIT License

---

